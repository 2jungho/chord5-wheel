# 코드진행 탭(Studio) 프렛보드 기능 고도화 설계

사용자가 요청한 "코드진행 및 키 센터에 따른 프렛보드 시각화" 기능에 대한 분석 및 구현 설계 문서입니다.

## 1. 개요
*   **목표**: 코드 진행 재생/선택 시, 현재 화성학적 문맥(Key Center)과 다음 코드(Voice Leading) 정보를 프렛보드 위에 직관적으로 시각화하여 연주자의 즉흥 연주(Soloing) 및 보이싱(Voicing) 선택을 돕습니다.
*   **핵심 기능**:
    1.  **배경 스케일(Ghost Notes)**: 키 센터에 맞는 펜타토닉/스케일 노트를 회색으로 표시.
    2.  **보이스 리딩(Voice Leading)**: 현재 코드 톤과 다음 코드 톤의 연결 관계 시각화.
    3.  **가이드 톤(Guide Tones)**: 코드의 핵심 성격(3도, 7도) 강조.

---

## 2. 세부 기능 및 구현 방법

### A. 키 센터 기반 펜타토닉 고스트 노트 (Scale Overlay)

#### 기능 정의
*   현재 선택된 코드 불럭과 상관없이, 곡 전체의 **Key Center**에 해당하는 스케일(주로 펜타토닉)을 지판 전체에 연하게(회색, Ghost) 표시합니다.
*   현재 코드 톤(Active Nodes)은 진하게 표시하여 스케일 노트와 구분합니다.

#### 구현 로직
1.  `StudioState`에서 현재 세션의 `Key`(예: C Major) 정보를 가져옵니다.
2.  `TheoryUtils`를 사용해 해당 키의 **Major/Minor Pentatonic Scale** 구성음을 계산합니다.
    *   예: C Major -> C, D, E, G, A
3.  `FretboardSection` 렌더링 시, **코드 톤이 아닌 좌표**에 해당 스케일 노트가 존재하면 `FretboardMarker`를 생성하되, 스타일을 `Ghost`(Gray, Small Dot)로 설정합니다.
4.  만약 현재 코드가 Non-Diatonic(키를 벗어난 코드)이라면, 펜타토닉 대신 해당 코드 스케일(Chord Scale)을 표시할지 옵션 처리가 필요합니다.

### B. 보이스 리딩 및 가이드 톤 시각화

#### 기능 정의
*   **가이드 톤**: 현재 코드의 3도와 7도 노트를 시각적으로 부각(예: 테두리 강조, 별도 색상)시킵니다.
*   **보이스 리딩**: 현재 코드에서 다음 코드로 진행할 때, 각 구성음이 가장 가까운 다음 코드 톤으로 어떻게 이동하는지 보여줍니다.

#### 구현 로직
1.  **가이드 톤**:
    *   `Chord` 분석 결과에서 인터벌이 `3`, `b3`, `7`, `b7`인 노트를 식별합니다.
    *   `FretboardPainter`에서 해당 노트 그릴 때 `Gold` 색상 테두리(Glow 효과)를 추가합니다.
2.  **보이스 리딩 연결**:
    *   다음 코드 블럭(`index + 1`)이 존재할 경우, 두 코드 간의 `VoiceLeading` 경로를 계산합니다 (기존 `TheoryUtils.findVoiceLeading` 활용).
    *   **옵션 1 (Target Ghost)**: 다음 코드의 구성음을 **빈 원(Hollow Circle)**이나 **반투명 노트**로 미리 표시하여, 손가락이 어디로 가야 할지 가이드합니다.
    *   **옵션 2 (Connection Lines)**: 현재 노트에서 다음 타겟 노트까지 **선(Line)**을 그립니다. (단, 프렛보드가 너무 복잡해질 수 있어 주의 필요).

---

## 3. 제약사항 및 고려사항 (Constraints & Considerations)

### 1. 시각적 과부하 (Visual Clutter)
*   **문제**: 코드 톤 + 펜타토닉 고스트 + 가이드 톤 + 다음 코드 타겟이 한꺼번에 표시되면 지판이 매우 혼란스러워집니다.
*   **해결책**:
    *   **레이어 토글(Layer Toggle)**: `ViewControlPanel`에 [Ghost Note], [Next Chord Hint], [Guide Tone] 스위치를 두어 사용자가 원하는 정보만 켜고 깰 수 있게 합니다.
    *   **우선순위 렌더링**: 코드 톤 > 가이드 톤 > 타겟 노트 > 고스트 노트 순으로 겹칠 경우 상위 요소를 표시합니다.

### 2. 보이싱의 모호성 (Voicing Ambiguity)
*   **문제**: 프렛보드는 6줄 전체를 보여주지만, 실제 연주는 특정 폼(CAGED)이나 일부 줄에서만 이루어집니다. "다음 코드"의 위치를 어디로 제안할지(가까운 곳? 같은 줄?)가 모호합니다.
*   **해결책**:
    *   **CAGED 연동**: 사용자가 선택한 CAGED 폼이 있다면, 그 폼 주변의 노트 위주로 보이스 리딩을 제안합니다.
    *   **Locality Rule**: 현재 선택된 보이싱 영역(예: 5~8프렛)에서 ±3프렛 이내의 타겟 노트만 표시합니다.

### 3. 모바일/반응형 대응
*   **문제**: 작은 화면에서 작은 도트들이 밀집되면 터치나 식별이 어렵습니다.
*   **해결책**: 고스트 노트는 크기를 현재 노트의 60% 수준으로 작게 그리고, 색상을 `DividerColor` 수준으로 낮춰 배경처럼 인식되게 합니다.

---

## 4. 제안하는 작업 순서 (Implementation Plan)

1.  **[Step 1] Ghost Note Layer 구현**:
    *   `GuitarUtils.generateFretboardMap` 수정: `keyCenter` 정보를 받아 펜타토닉 노트를 추가 생성하는 로직 구현.
    *   `FretboardMarker` 모델에 `isGhost` 속성 추가.
    *   `FretboardPainter`에서 `isGhost`일 경우 회색 점으로 렌더링.

2.  **[Step 2] Guide Tone Highlighting**:
    *   `Chord` 모델 분석 시 가이드 톤(3, 7) 식별.
    *   `FretboardPainter`에서 코드 톤이 가이드 톤일 경우 강조 스타일 적용.

3.  **[Step 3] Next Chord Hint (Voice Leading)**:
    *   `StudioState`에서 다음 코드 정보 참조.
    *   다음 코드의 구성음을 `FretboardMarker`로 생성하되 `isTarget` 속성 부여.
    *   `FretboardPainter`에서 `isTarget`은 투명도 있는 색상 또는 테두리만 있는 원으로 표시.

4.  **[Step 4] UI Control**:
    *   `ViewControlPanel`에 해당 기능들을 켜고 끌 수 있는 `FilterChip` 또는 `Switch` 추가.
